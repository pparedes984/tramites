/*
 * File: app/view/winNuevoTramiteViewController.js
 *
 * This file was generated by Sencha Architect version 4.2.4.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Tramites.view.winNuevoTramiteViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.winnuevotramite',

    onSave: function(button, e, eOpts) {
        var me = this;
        var forma = Ext.getCmp('frmTramite').getForm(),
            store = Ext.StoreManager.lookup('Registro');

        if (forma.isValid()) {
            var rec    = forma.getRecord();
            var values = forma.getValues();
            rec.set(values);
            store.add(rec);
            store.sync(
            {
                params: {
                    idParametro: rec.data.TRA_PRM_ID//Se envia el codigo del parametro
                },
                success: function(batch, options)
                {

                    store.commitChanges();
                    forma.loadRecord(rec);
                    store.load();
                    Ext.getCmp('grdTramite').getStore().load();
                    Ext.Msg.alert('Datos Guardados','Se han guardado los datos exitosamente');

                    me.onCancel();
                },
                failure: function(batch, options)
                {
                    //var reader = batch.proxy.getReader();
                    console.log(batch.proxy.getReader().jsonData.message);
                    Ext.Msg.alert('Error', 'Hubo un error');
                    var strTramiteReg = Ext.getStore('Registro');
                    strTramiteReg.removeAll();
                    Ext.getCmp('grdTramite').store.removeAll();
                    strTramiteReg.proxy.extraParams = {
                        busqueda: 0//Parametro para elegir el tipo de busqueda
                    };
                    strTramiteReg.load();
                    me.onCancel();
                }
            }
            );
        }

        else
        {
            Ext.Msg.alert('Ingrese los datos correctamente');
        }
    },

    onCancel: function(button, e, eOpts) {
        Ext.getCmp('winNuevoTramite').close();
    },

    onCbParametro2Select: function(combo, record, eOpts) {
        Ext.getCmp('cbAsunto2').enable(true);
        Ext.getCmp('cbAsunto2').setValue(null);
    },

    onCbAsunto2Expand: function(field, eOpts) {
        if(Ext.getCmp('cbParametro2').getValue()!==null){
            var txtparametro = Ext.getCmp('cbParametro2').getValue();
            var strAsunto = Ext.getStore('Asunto');
            strAsunto.proxy.extraParams = {
                parametro: txtparametro
            };
            strAsunto.load();
        }
    },

    onWinNuevoTramiteAfterRender: function(component, eOpts) {
        //Formulario
        var forma = Ext.getCmp('frmTramite').getForm();
        if(component.curRec){ //Actualizar tramite
            forma.loadRecord(component.curRec);
            Ext.getCmp('cbParametro2').setDisabled(true);

            //Cargar combobox Unidad
            var strUnidad = Ext.getStore('Unidad');
            strUnidad.proxy.extraParams = {
                usuario: USUARIO
            };
            strUnidad.load();
        }

        else//Nuevo tramite
        {
            var rec = Ext.create('model.registromodel');
            forma.reset();
            forma.loadRecord(rec);
            Ext.getCmp('txtTraCodigo').setValue(null);
            //Cargar combobox Unidad
            var strUnidad = Ext.getStore('Unidad');
            strUnidad.proxy.extraParams = {
                usuario: USUARIO
            };
            strUnidad.load();
            Ext.getCmp('cbAsunto2').disable(true);//Deshabilita el combobobox de Asunto
        }
        Ext.getCmp('dtFecha').setValue(new Date());//Fecha tramite
    }

});
