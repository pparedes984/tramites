/*
 * File: app/view/panel/pnlNuevoViewController.js
 *
 * This file was generated by Sencha Architect version 4.2.4.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Tramites.view.panel.pnlNuevoViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.panel.pnlnuevo',

    onButtonNuevoClick: function(button, e, eOpts) {
        var winNuevo = Ext.create('Tramites.view.winNuevoTramite');
        winNuevo.show();//Ventana para ingresar el nuevo tramite
    },

    onButtonAnularClick: function(button, e, eOpts) {
        var grid = Ext.getCmp('grdTramite');
        var arrayKeys = grid.getSelectionModel().selected.items;
        var indice = grid.getSelectionModel().selectionStartIdx;
        var me =this;
        console.log(arrayKeys);
        if(arrayKeys.length === 0)
        Ext.Msg.alert('Error', 'Debe escoger un registro');
        else
        {
            Ext.Msg.show({
                title: 'Atención',
                msg: 'Está seguro de borrar esta fila y los registros asociados?',
                icon: Ext.Msg.QUESTION,
                buttonText: {
                    yes: 'Si',
                    no: 'No'
                },
                buttons: Ext.Msg.YESNO,
                fn: function (btn) {
                    if (btn == 'yes') {
                        for(i = 0; i < arrayKeys.length; i++){
                            Ext.Ajax.request
                            (
                            {
                                method: 'post',
                                url: '../servidor/tramites/registro/delete',
                                params: {
                                    idTramite: arrayKeys[i].data.TRA_CODIGO,
                                    idParametro: arrayKeys[i].data.TRA_PRM_ID
                                },
                                success: function (response, options) {
                                    var responseData = Ext.JSON.decode(response.responseText);
                                    if (!responseData.success) {
                                        Ext.Msg.show//Mensaje de Error
                                        (
                                        {
                                            title: 'Error',
                                            msg: responseData.message,
                                            icon: Ext.Msg.ERROR,
                                            buttons: Ext.Msg.OK
                                        }
                                        );
                                        me.onButtonClickRefresh();
                                    }
                                    else {
                                        grid.getStore().removeAt(indice);
                                        var strRegistro = Ext.getStore('Registro');
                                        strRegistro.load();
                                        Ext.Msg.alert('Correcto', 'Tramite(s) anulado(s)');
                                    }
                                },
                                failure: function (response, options){
                                    Ext.Msg.show//Mensaje de Error
                                    (
                                    {
                                        title: 'Error',
                                        msg: responseData.message,
                                        icon: Ext.Msg.ERROR,
                                        buttons: Ext.Msg.OK
                                    }
                                    );
                                    this.onButtonClickRefresh();
                                }
                            }
                        );}
                    }
                }
            });
        }
    },

    onButtonClickImprimir: function(button, e, eOpts) {
        //Imprimir
        var me = this;
        var grid = me.getView().down('#grdTramite');
        var arrayKeys = grid.getSelectionModel().selected.items;

        if(arrayKeys.length === 0)
        Ext.Msg.alert('Error', 'Debe escoger un registro');
        else if(arrayKeys.length >1 )
        Ext.Msg.alert('Error', 'Solo debe escoger un registro');
        else
        {
            console.log(arrayKeys);
            Ext.Ajax.request
            (
            {
                method: 'post',
                url: '../servidor/tramites/registro/getReporte',
                params: {
                    tracodigo: arrayKeys[0].data.TRA_CODIGO,
                    parametro: arrayKeys[0].data.TRA_PRM_ID,
                },
                /* success: function(response){
                var _url = response.responseText;
                console.log(response.responseText);
                new Ext.Window({
                title: 'Trámite',
                id: 'pdfWindow',
                layout: 'fit',
                width: 800,
                height: 700,
                modal: true,
                closeAction: 'destroy',
                items: [{
                xtype: 'component',
                autoEl: {
                tag: 'iframe',
                style: 'height:100%; width:100%; border:none',
                src: _url
                }
                }]
                }).show();
                }*/
            }
            );
        }
    },

    onButtonClickRefresh: function(button, e, eOpts) {
        var tramiteNum =  "";
        var parametroNum = Ext.getCmp('cbParametroPrincipal').getValue();

        if(parametroNum!== null){
            var strTramiteReg = Ext.getStore('Registro');
            Ext.getCmp('grdTramite').getStore().removeAll();
            strTramiteReg.proxy.extraParams = {
                busqueda: 4,//Parametro para elegir el tipo de busqueda
                tramite: tramiteNum,
                parametro: parametroNum
            };
            strTramiteReg.load();
        }
        else{
            Ext.Msg.alert('Alerta','Seleccione un parámetro');
        }
        Ext.getCmp('txtTramiteBuscar').setValue(null);
    },

    onBtnBuscarClick: function(button, e, eOpts) {
        var tramiteNum =  Ext.getCmp('txtTramiteBuscar').getValue();
        var parametroNum = Ext.getCmp('cbParametroPrincipal').getValue();

        if(parametroNum!== null){
            var strTramiteReg = Ext.getStore('Registro');
            Ext.getCmp('grdTramite').getStore().removeAll();
            strTramiteReg.proxy.extraParams = {
                busqueda: 4,//Parametro para elegir el tipo de busqueda
                tramite: tramiteNum,
                parametro: parametroNum
            };
            strTramiteReg.load();
        }
        else{
            Ext.Msg.alert('Alerta','Seleccione un parámetro');
        }
    },

    onGrdTramiteCellDblClick: function(tableview, td, cellIndex, record, tr, rowIndex, e, eOpts) {
        if (record)
        {
            var winNuevoTramite = Ext.create('Tramites.view.winNuevoTramite');
            winNuevoTramite.curRec = record;
            winNuevoTramite.store = Ext.getStore('Registro');
            Ext.getStore('Registro').load();
            winNuevoTramite.show();
        }
        else
        {
            Ext.Msg.alert('Error', 'Seleccione un registro para editar');
        }
    },

    onPnlCentralNuevoRender: function(component, eOpts) {
        this.onButtonClickRefresh();
    }

});
